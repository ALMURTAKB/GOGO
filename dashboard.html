<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCxZKjnVEVjVBbgwAOUUbEg9D4KbEJqUG4",
    authDomain: "gogo-580c9.firebaseapp.com",
    projectId: "gogo-580c9",
    storageBucket: "gogo-580c9.appspot.com",
    messagingSenderId: "1017270070832",
    appId: "1:1017270070832:web:802137b9719a1c525747f5",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let allOrders = [];
  let isAdmin = false; // حالة صلاحية المدير

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    });
  }

  function formatTimestamp(timestamp) {
    if (!timestamp) return "-";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleString("ar-EG", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
  }

  function fetchOrders() {
    db.collection("orders").orderBy("createdAt", "desc").onSnapshot(snapshot => {
      allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      displayOrders(allOrders);
    });
  }

  function displayOrders(orders) {
    const ordersContainer = document.getElementById("orders");
    if (orders.length === 0) {
      ordersContainer.innerHTML = '<tr><td colspan="11" class="text-center p-4 text-gray-500">لا توجد طلبات</td></tr>';
      return;
    }

    let html = "";
    orders.forEach(order => {
      const name = order.name || "-";
      const productName = order.productName || "-";
      const governorate = order.governorate || "-";
      const phone1 = order.phone1 || "-";
      const phone2 = (order.phone2 && order.phone2.trim() !== "") ? order.phone2 : "-";
      const address1 = order.address1 || "-";
      const landmark = order.landmark || "-";
      const status = order.status || "قيد التنفيذ";
      const createdAtFormatted = formatTimestamp(order.createdAt);

      html += `
        <tr class="hover:bg-gray-50">
          <td class="p-3 border-b">${name}</td>
          <td class="p-3 border-b">${productName}</td>
          <td class="p-3 border-b">${governorate}</td>
          <td class="p-3 border-b">${phone1}</td>
          <td class="p-3 border-b">${phone2}</td>
          <td class="p-3 border-b">${address1}</td>
          <td class="p-3 border-b">${landmark}</td>
          <td class="p-3 border-b">${createdAtFormatted}</td>
          <td class="p-3 border-b">${status}</td>
          <td class="p-3 border-b text-center">
            <select onchange="toggleStatus('${order.id}', this.value)" class="border rounded px-2 py-1 cursor-pointer">
              <option value="قيد التنفيذ" ${status === 'قيد التنفيذ' ? 'selected' : ''}>قيد التنفيذ</option>
              <option value="مكتمل ✅" ${status === 'مكتمل ✅' ? 'selected' : ''}>مكتمل ✅</option>
              <option value="ملغي" ${status === 'ملغي' ? 'selected' : ''}>ملغي</option>
            </select>
          </td>
          <td class="p-3 border-b text-center">
            ${isAdmin ? `<button onclick="deleteOrder('${order.id}')" class="text-red-600 hover:text-red-800">🗑 حذف</button>` : ''}
          </td>
        </tr>
      `;
    });

    ordersContainer.innerHTML = html;
  }

  function toggleStatus(id, newStatus) {
    db.collection("orders").doc(id).update({ status: newStatus })
      .catch(err => alert("خطأ في تحديث الحالة: " + err.message));
  }

  function deleteOrder(id) {
    if (!isAdmin) {
      alert("غير مصرح لك بحذف الطلبات.");
      return;
    }
    if (confirm("هل أنت متأكد من حذف هذا الطلب؟")) {
      db.collection("orders").doc(id).delete()
        .then(() => alert("تم حذف الطلب بنجاح"))
        .catch(err => alert("خطأ في حذف الطلب: " + err.message));
    }
  }

  function filterOrders() {
    const filterValue = document.getElementById("filter").value;
    const filtered = filterValue === "all"
      ? allOrders
      : allOrders.filter(order => order.status === filterValue);
    displayOrders(filtered);
  }

  function uploadLogo(event) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('logo').src = e.target.result;
    };
    reader.readAsDataURL(event.target.files[0]);
  }

  function exportToExcel() {
    const filteredOrders = document.querySelectorAll("#orders tr");
    if (!filteredOrders.length) return alert("لا يوجد بيانات للتصدير.");

    const table = document.createElement("table");
    table.innerHTML = document.querySelector("thead").outerHTML + document.querySelector("#orders").outerHTML;

    const workbook = XLSX.utils.table_to_book(table, { sheet: "الطلبات" });
    XLSX.writeFile(workbook, "طلبات.xlsx");
  }

  function saveProductData() {
    const name = document.getElementById("productName").value;
    const image = document.getElementById("productImage").value;
    const originalPrice = document.getElementById("originalPrice").value;
    const discountPrice = document.getElementById("discountPrice").value;

    const productData = {
      name,
      image,
      originalPrice,
      discountPrice,
      updatedAt: new Date()
    };

    db.collection("settings").doc("product").set(productData)
      .then(() => alert("✅ تم تحديث بيانات المنتج بنجاح"))
      .catch(error => alert("❌ فشل في التحديث: " + error.message));
  }

  auth.onAuthStateChanged(async user => {
    if (user) {
      // جلب بيانات المستخدم للتأكد من الصلاحية
      try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          isAdmin = userData.isAdmin === true;
        } else {
          isAdmin = false;
        }
      } catch (error) {
        console.error("خطأ في جلب بيانات المستخدم:", error);
        isAdmin = false;
      }
      fetchOrders();
    } else {
      window.location.href = "login.html";
    }
  });
</script>
