<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCxZKjnVEVjVBbgwAOUUbEg9D4KbEJqUG4",
    authDomain: "gogo-580c9.firebaseapp.com",
    projectId: "gogo-580c9",
    storageBucket: "gogo-580c9.appspot.com",
    messagingSenderId: "1017270070832",
    appId: "1:1017270070832:web:802137b9719a1c525747f5",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let allOrders = [];
  let isAdmin = false; // Ø­Ø§Ù„Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "login.html";
    });
  }

  function formatTimestamp(timestamp) {
    if (!timestamp) return "-";
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleString("ar-EG", {
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
  }

  function fetchOrders() {
    db.collection("orders").orderBy("createdAt", "desc").onSnapshot(snapshot => {
      allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      displayOrders(allOrders);
    });
  }

  function displayOrders(orders) {
    const ordersContainer = document.getElementById("orders");
    if (orders.length === 0) {
      ordersContainer.innerHTML = '<tr><td colspan="11" class="text-center p-4 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
      return;
    }

    let html = "";
    orders.forEach(order => {
      const name = order.name || "-";
      const productName = order.productName || "-";
      const governorate = order.governorate || "-";
      const phone1 = order.phone1 || "-";
      const phone2 = (order.phone2 && order.phone2.trim() !== "") ? order.phone2 : "-";
      const address1 = order.address1 || "-";
      const landmark = order.landmark || "-";
      const status = order.status || "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°";
      const createdAtFormatted = formatTimestamp(order.createdAt);

      html += `
        <tr class="hover:bg-gray-50">
          <td class="p-3 border-b">${name}</td>
          <td class="p-3 border-b">${productName}</td>
          <td class="p-3 border-b">${governorate}</td>
          <td class="p-3 border-b">${phone1}</td>
          <td class="p-3 border-b">${phone2}</td>
          <td class="p-3 border-b">${address1}</td>
          <td class="p-3 border-b">${landmark}</td>
          <td class="p-3 border-b">${createdAtFormatted}</td>
          <td class="p-3 border-b">${status}</td>
          <td class="p-3 border-b text-center">
            <select onchange="toggleStatus('${order.id}', this.value)" class="border rounded px-2 py-1 cursor-pointer">
              <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
              <option value="Ù…ÙƒØªÙ…Ù„ âœ…" ${status === 'Ù…ÙƒØªÙ…Ù„ âœ…' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„ âœ…</option>
              <option value="Ù…Ù„ØºÙŠ" ${status === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
            </select>
          </td>
          <td class="p-3 border-b text-center">
            ${isAdmin ? `<button onclick="deleteOrder('${order.id}')" class="text-red-600 hover:text-red-800">ğŸ—‘ Ø­Ø°Ù</button>` : ''}
          </td>
        </tr>
      `;
    });

    ordersContainer.innerHTML = html;
  }

  function toggleStatus(id, newStatus) {
    db.collection("orders").doc(id).update({ status: newStatus })
      .catch(err => alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: " + err.message));
  }

  function deleteOrder(id) {
    if (!isAdmin) {
      alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª.");
      return;
    }
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
      db.collection("orders").doc(id).delete()
        .then(() => alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­"))
        .catch(err => alert("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨: " + err.message));
    }
  }

  function filterOrders() {
    const filterValue = document.getElementById("filter").value;
    const filtered = filterValue === "all"
      ? allOrders
      : allOrders.filter(order => order.status === filterValue);
    displayOrders(filtered);
  }

  function uploadLogo(event) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('logo').src = e.target.result;
    };
    reader.readAsDataURL(event.target.files[0]);
  }

  function exportToExcel() {
    const filteredOrders = document.querySelectorAll("#orders tr");
    if (!filteredOrders.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.");

    const table = document.createElement("table");
    table.innerHTML = document.querySelector("thead").outerHTML + document.querySelector("#orders").outerHTML;

    const workbook = XLSX.utils.table_to_book(table, { sheet: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª" });
    XLSX.writeFile(workbook, "Ø·Ù„Ø¨Ø§Øª.xlsx");
  }

  function saveProductData() {
    const name = document.getElementById("productName").value;
    const image = document.getElementById("productImage").value;
    const originalPrice = document.getElementById("originalPrice").value;
    const discountPrice = document.getElementById("discountPrice").value;

    const productData = {
      name,
      image,
      originalPrice,
      discountPrice,
      updatedAt: new Date()
    };

    db.collection("settings").doc("product").set(productData)
      .then(() => alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­"))
      .catch(error => alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: " + error.message));
  }

  auth.onAuthStateChanged(async user => {
    if (user) {
      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      try {
        const userDoc = await db.collection("users").doc(user.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          isAdmin = userData.isAdmin === true;
        } else {
          isAdmin = false;
        }
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
        isAdmin = false;
      }
      fetchOrders();
    } else {
      window.location.href = "login.html";
    }
  });
</script>
